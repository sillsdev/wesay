#!/usr/bin/make -f
# -*- makefile -*-

#export CONFIGURATION=Release
export CONFIGURATION=Debug
export XDG_CONFIG_HOME=$HOME/.config

export MONO_PREFIX=/opt/mono-sil

DESTDIR=../debian/wesay
LIB=/usr/lib/wesay

define MERCURIAL_INI
[extensions]
eol=
hgext.graphlog=
convert=
fixutf8=$(LIB)/MercurialExtensions/fixutf8/fixutf8.py
endef
export MERCURIAL_INI

%:
	dh $@ --with=cli --parallel

override_dh_auto_configure:

override_dh_auto_build:
	cd build && \
	./buildupdate.mono.sh && \
	./TestBuild.sh $(CONFIGURATION)
	rm -f output$(CONFIGURATION)/[Gg]ecko*

override_dh_auto_test:

override_dh_auto_install:
	. ./environ && \
	cd build && \
	xbuild /target:Install /p:Configuration=$(CONFIGURATION) /p:InstallDir=$(DESTDIR)/usr build.mono.proj
	# Apparently the downloaded mercurial.ini doesn't have the right fixutf8 config, and it also has
	# wrong line endings, so we re-create the entire file
	echo "$$MERCURIAL_INI" > $(DESTDIR)$(LIB)/Mercurial/mercurial.ini

# Don't export any assemblies to other packages
override_dh_makeclilibs:

# Include mono-sil in shlib dirs searched
override_dh_shlibdeps:
	dh_shlibdeps -l$(MONO_PREFIX)/lib

# Include mono-sil in cli dirs searched. Rename irrKlang.NET4 prior to running
# dh_clideps - that searches for an empty moduleref.
override_dh_clideps:
	mkdir -p debian/tmp/usr && ln -s $(MONO_PREFIX)/* debian/tmp/usr/ && \
	mv debian/wesay/usr/lib/wesay/irrKlang.NET4.dll debian/wesay/usr/lib/wesay/irrKlang.NET4.dll.ignore && \
	PATH=$(MONO_PREFIX)/bin:$(PATH) \
	dh_clideps internal-mono -l$(MONO_PREFIX)/lib \
		--exclude-moduleref=security.dll \
		--exclude-moduleref=icuuc58.dll --exclude-moduleref=icuin58.dll \
		--exclude-moduleref=icuuc57.dll --exclude-moduleref=icuin57.dll \
		--exclude-moduleref=icuuc56.dll --exclude-moduleref=icuin56.dll \
		--exclude-moduleref=icuuc55.dll --exclude-moduleref=icuin55.dll \
		--exclude-moduleref=icuuc54.dll --exclude-moduleref=icuin54.dll \
		--exclude-moduleref=icuuc52.dll --exclude-moduleref=icuin52.dll \
		--exclude-moduleref=icuuc48.dll --exclude-moduleref=icuin48.dll \
		--exclude-moduleref=libicuuc.so --exclude-moduleref=libicui18n.so \
		--exclude-moduleref=icu.net --exclude-moduleref=libdl.so \
		--exclude-moduleref=xul --exclude-moduleref=libxul.so \
		--exclude-moduleref=mozjs --exclude-moduleref=mozglue \
		--exclude-moduleref=libgeckofix.so --exclude-moduleref=Geckofx-Core.dll \
		--exclude-moduleref=Autofac --exclude-moduleref=NDesk.DBus && \
	mv debian/wesay/usr/lib/wesay/irrKlang.NET4.dll.ignore debian/wesay/usr/lib/wesay/irrKlang.NET4.dll

# Don't strip debug symbols -- we want them for informative crash stack traces
override_dh_strip:

override_dh_clistrip:
